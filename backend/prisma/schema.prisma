// VideoShrink Database Schema
// Supports both PostgreSQL and SQLite

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String?  // Optional for guest mode
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  jobs Job[]

  @@map("users")
}

model Job {
  id          Int       @id @default(autoincrement())
  userId      Int?
  user        User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  // File information
  inputFile   String    // Path to original uploaded file
  outputFile  String?   // Path to compressed output file
  fileName    String    // Original filename
  fileSize    Int       // Original file size in bytes
  outputSize  Int?      // Compressed file size in bytes

  // Job configuration
  preset      String?   // Compression preset (high/medium/low)
  codec       String?   // Video codec (h264/h265)
  targetSize  Float?    // Target size percentage (e.g., 0.5 for 50%)
  crf         Int?      // Constant Rate Factor
  bitrate     String?   // Target bitrate
  resolution  String?   // Target resolution (e.g., "1920x1080")

  // Job status
  status      String    @default("pending") // pending, processing, completed, failed
  progress    Float     @default(0.0)       // 0.0 to 100.0
  error       String?   // Error message if failed

  // Metadata
  thumbnailPath String? // Path to generated thumbnail
  previewPath   String? // Path to preview video
  duration      Float?  // Video duration in seconds

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  startedAt   DateTime? // When job processing started
  completedAt DateTime? // When job processing completed

  @@map("jobs")
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model FileUpload {
  id          Int      @id @default(autoincrement())
  filename    String
  originalName String
  mimeType    String
  size        Int
  path        String
  uploadedAt  DateTime @default(now())
  expiresAt   DateTime? // For temporary file cleanup

  @@map("file_uploads")
  @@index([expiresAt])
}

model ConversionJob {
  id          Int       @id @default(autoincrement())
  userId      Int?

  // File information
  inputFile   String    // Path to source file
  outputFile  String?   // Path to converted file
  fileName    String    // Original filename
  fileSize    Int       // Original file size in bytes
  outputSize  Int?      // Converted file size in bytes

  // Conversion settings
  fromFormat  String    // Source format extension (e.g., "mkv")
  toFormat    String    // Target format extension (e.g., "mp4")
  preset      String?   // Conversion preset (fast/balanced/high-quality/etc)
  videoCodec  String?   // Video codec override
  audioCodec  String?   // Audio codec override

  // Job status
  status      String    @default("pending") // pending, processing, completed, failed
  progress    Float     @default(0.0)       // 0.0 to 100.0
  error       String?   // Error message if failed

  // Metadata
  thumbnailPath String? // Path to generated thumbnail (for video conversions)

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  startedAt   DateTime? // When conversion started
  completedAt DateTime? // When conversion completed

  @@map("conversion_jobs")
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model AudioExtractionJob {
  id          Int       @id @default(autoincrement())
  userId      Int?

  // File information
  inputFile   String    // Path to source video file
  outputFile  String?   // Path to extracted audio file
  fileName    String    // Original filename
  fileSize    Int       // Original file size in bytes
  outputSize  Int?      // Extracted audio file size in bytes

  // Audio extraction settings
  outputFormat String   // Output audio format (mp3/aac/flac/etc)
  audioCodec   String   // Audio codec to use
  bitrate      String?  // Audio bitrate (e.g., "192k")

  // Job status
  status      String    @default("pending") // pending, processing, completed, failed
  progress    Float     @default(0.0)       // 0.0 to 100.0
  error       String?   // Error message if failed

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  startedAt   DateTime? // When extraction started
  completedAt DateTime? // When extraction completed

  @@map("audio_extraction_jobs")
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model TrimJob {
  id          Int       @id @default(autoincrement())
  userId      Int?

  // File information
  inputFile   String    // Path to source video file
  outputFile  String?   // Path to trimmed video file
  fileName    String    // Original filename
  fileSize    Int       // Original file size in bytes
  outputSize  Int?      // Trimmed video file size in bytes

  // Trim settings
  startTime   String    // Start time (HH:MM:SS or seconds)
  endTime     String    // End time (HH:MM:SS or seconds)
  duration    Float     // Duration of trimmed segment in seconds
  lossless    Boolean   @default(true) // Use -c copy (no re-encoding)

  // Job status
  status      String    @default("pending") // pending, processing, completed, failed
  progress    Float     @default(0.0)       // 0.0 to 100.0
  error       String?   // Error message if failed

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  startedAt   DateTime? // When trim started
  completedAt DateTime? // When trim completed

  @@map("trim_jobs")
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model GifJob {
  id          Int       @id @default(autoincrement())
  userId      Int?

  // File information
  inputFile   String    // Path to source video file
  outputFile  String?   // Path to generated GIF file
  fileName    String    // Original filename
  fileSize    Int       // Original file size in bytes
  outputSize  Int?      // GIF file size in bytes

  // GIF settings
  startTime   String    @default("0") // Start time (HH:MM:SS or seconds)
  endTime     String    // End time (HH:MM:SS or seconds)
  duration    Float     // Duration of GIF in seconds
  fps         Int       @default(10) // Frames per second (5-30)
  width       Int       @default(480) // Width in pixels
  optimize    Boolean   @default(true) // Use palette optimization

  // Job status
  status      String    @default("pending") // pending, processing, completed, failed
  progress    Float     @default(0.0)       // 0.0 to 100.0
  error       String?   // Error message if failed

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  startedAt   DateTime? // When GIF creation started
  completedAt DateTime? // When GIF creation completed

  @@map("gif_jobs")
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model ThumbnailJob {
  id          Int       @id @default(autoincrement())
  userId      Int?

  // File information
  inputFile   String    // Path to source video file
  outputFiles String?   // JSON array of thumbnail file paths
  fileName    String    // Original filename
  fileSize    Int       // Original file size in bytes

  // Thumbnail settings
  timestamps  String?   // JSON array of timestamps or null for auto-intervals
  count       Int       @default(1) // Number of thumbnails to generate
  width       Int       @default(320) // Width in pixels

  // Job status
  status      String    @default("pending") // pending, processing, completed, failed
  progress    Float     @default(0.0)       // 0.0 to 100.0
  error       String?   // Error message if failed

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  startedAt   DateTime? // When thumbnail generation started
  completedAt DateTime? // When thumbnail generation completed

  @@map("thumbnail_jobs")
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model FrameExtractionJob {
  id          Int       @id @default(autoincrement())
  userId      Int?

  // File information
  inputFile   String    // Path to source video file
  outputFiles String?   // JSON array of frame file paths
  fileName    String    // Original filename
  fileSize    Int       // Original file size in bytes

  // Frame extraction settings
  outputFormat   String  // jpg or png
  fps            Float   @default(1)
  startTime      String  @default("0") // Start time (HH:MM:SS or seconds)
  endTime        String  // End time (HH:MM:SS or seconds)
  duration       Float   // Duration of extraction segment in seconds
  estimatedFrames Int    // Estimated number of frames
  frameCount     Int?    // Actual number of frames generated

  // Job status
  status      String    @default("pending") // pending, processing, completed, failed
  progress    Float     @default(0.0)       // 0.0 to 100.0
  error       String?   // Error message if failed

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  startedAt   DateTime? // When extraction started
  completedAt DateTime? // When extraction completed

  @@map("frame_extraction_jobs")
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}
